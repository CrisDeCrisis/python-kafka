# ü§ñ AI Server - Servidor de Inteligencia Artificial

Servidor FastAPI de alta performance que integra **LangChain**, **Ollama** y **ChromaDB** para proporcionar capacidades avanzadas de procesamiento de lenguaje natural con contexto vectorial y streaming en tiempo real.

> üìã **Nota**: Para la documentaci√≥n completa del sistema incluyendo Kafka, consulta [README_KAFKA.md](../README_KAFKA.md)

## ‚ú® Caracter√≠sticas del Servidor

- üöÄ **FastAPI**: Framework moderno con documentaci√≥n autom√°tica
- üß† **LangChain**: Orquestaci√≥n avanzada de LLMs
- üè† **Ollama**: Modelos de IA ejecut√°ndose localmente
- üîç **ChromaDB**: Base de datos vectorial para b√∫squeda sem√°ntica
- ‚ö° **Streaming**: Respuestas en tiempo real
- üí¨ **Contexto Conversacional**: Mantiene historial de conversaciones
- üìÑ **Gesti√≥n de Documentos**: Procesamiento autom√°tico de embeddings
- üîÑ **Integraci√≥n Kafka**: Distribuci√≥n de mensajes (opcional)

## üõ†Ô∏è Modelos de IA Utilizados

| Componente        | Modelo             | Prop√≥sito                        |
| ----------------- | ------------------ | -------------------------------- |
| **LLM Principal** | `phi3:3.8b`        | Generaci√≥n de texto y respuestas |
| **Embeddings**    | `nomic-embed-text` | Vectorizaci√≥n de documentos      |

## ‚ö° Inicio R√°pido

### 1. Prerrequisitos

```powershell
# Verificar Python
python --version  # Requiere 3.11+

# Instalar y configurar Ollama
ollama pull phi3:3.8b
ollama pull nomic-embed-text
```

### 2. Instalaci√≥n

```powershell
# Crear entorno virtual
python -m venv .venv
.venv\Scripts\activate

# Instalar dependencias
pip install -r requirements.txt

# Configurar variables de entorno
copy .env.example .env
```

### 3. Iniciar Servidor

```powershell
# M√©todo directo
python run.py

# Con utilidades (recomendado)
python utils.py start

# Desarrollo con recarga autom√°tica
python utils.py start --reload
```

### 4. Verificar Funcionamiento

```powershell
# Health check
curl http://localhost:8000/health/

# Documentaci√≥n interactiva
# Abrir: http://localhost:8000/docs
```

## üéØ API Endpoints

### üìã Documentaci√≥n Autom√°tica

- **Swagger UI**: http://localhost:8000/docs
- **ReDoc**: http://localhost:8000/redoc

### üí¨ Chat y Conversaci√≥n

```powershell
# Chat b√°sico
curl -X POST "http://localhost:8000/chat/" `
  -H "Content-Type: application/json" `
  -d '{"message": "¬øC√≥mo est√°s?", "use_context": false, "temperature": 0.7}'

# Chat con contexto vectorial
curl -X POST "http://localhost:8000/chat/" `
  -H "Content-Type: application/json" `
  -d '{"message": "Explica machine learning", "use_context": true, "conversation_id": "conv-123"}'

# Streaming en tiempo real
curl -X POST "http://localhost:8000/chat/stream" `
  -H "Content-Type: application/json" `
  -d '{"message": "Escribe un poema", "use_context": false}'

# Historial de conversaci√≥n
curl "http://localhost:8000/chat/history/conv-123"
```

### üìÑ Gesti√≥n de Documentos

```powershell
# A√±adir documento al contexto
curl -X POST "http://localhost:8000/documents/" `
  -H "Content-Type: application/json" `
  -d '{"content": "Informaci√≥n importante...", "metadata": {"tipo": "ejemplo"}, "conversation_id": "conv-123"}'

# Estad√≠sticas de documentos
curl "http://localhost:8000/documents/stats"
```

### üîç Monitoreo y Salud

```powershell
# Health check general
curl "http://localhost:8000/health/"

# Estado de modelos
curl "http://localhost:8000/health/models"

# Informaci√≥n del sistema
curl "http://localhost:8000/"
```

## ‚öôÔ∏è Configuraci√≥n

### üîß Variables de Entorno

Crea un archivo `.env` basado en `.env.example`:

```env
# Servidor
HOST=0.0.0.0
PORT=8000
DEBUG=false
LOG_LEVEL=INFO

# Ollama
OLLAMA_BASE_URL=http://localhost:11434
LLM_MODEL=phi3:3.8b
EMBEDDING_MODEL=nomic-embed-text

# ChromaDB
CHROMA_PERSIST_DIRECTORY=./chroma_db
COLLECTION_NAME=conversation_context

# Kafka (opcional)
KAFKA_ENABLE=true
KAFKA_BOOTSTRAP_SERVERS=["localhost:9092"]
```

### üèóÔ∏è Personalizaci√≥n de Servicios

| Archivo                         | Prop√≥sito            | Personalizaci√≥n            |
| ------------------------------- | -------------------- | -------------------------- |
| `config.py`                     | Configuraci√≥n global | Variables de entorno, URLs |
| `services/chat_service.py`      | L√≥gica principal     | Flujo de conversaci√≥n      |
| `services/llm_service.py`       | Integraci√≥n Ollama   | Prompts, modelos           |
| `services/embedding_service.py` | Vectorizaci√≥n        | Chunk size, estrategias    |
| `services/vector_db_service.py` | ChromaDB             | Colecciones, b√∫squedas     |
| `api/chat.py`                   | Endpoints chat       | Validaciones, respuestas   |

## üèóÔ∏è Arquitectura del Servidor

### üìÅ Estructura de Archivos

```
server-python/
‚îú‚îÄ‚îÄ üìÅ app/                    # C√≥digo principal
‚îÇ   ‚îú‚îÄ‚îÄ üìÑ main.py             # Aplicaci√≥n FastAPI
‚îÇ   ‚îú‚îÄ‚îÄ üìÑ config.py           # Configuraci√≥n centralizada
‚îÇ   ‚îú‚îÄ‚îÄ üìÑ models.py           # Modelos Pydantic
‚îÇ   ‚îú‚îÄ‚îÄ üìÑ dependencies.py     # Inyecci√≥n de dependencias
‚îÇ   ‚îú‚îÄ‚îÄ üìÑ logging_config.py   # Configuraci√≥n de logs
‚îÇ   ‚îú‚îÄ‚îÄ üìÅ api/                # Endpoints REST
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ chat.py         # Rutas de chat
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ documents.py    # Rutas de documentos
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ üìÑ health.py       # Health checks
‚îÇ   ‚îî‚îÄ‚îÄ üìÅ services/           # L√≥gica de negocio
‚îÇ       ‚îú‚îÄ‚îÄ üìÑ chat_service.py     # Orquestador principal
‚îÇ       ‚îú‚îÄ‚îÄ üìÑ llm_service.py      # Comunicaci√≥n con Ollama
‚îÇ       ‚îú‚îÄ‚îÄ üìÑ embedding_service.py # Generaci√≥n de embeddings
‚îÇ       ‚îú‚îÄ‚îÄ üìÑ vector_db_service.py # Gesti√≥n ChromaDB
‚îÇ       ‚îî‚îÄ‚îÄ üìÑ kafka_service.py    # Integraci√≥n Kafka
‚îú‚îÄ‚îÄ üìÅ chroma_db/             # Base de datos vectorial
‚îú‚îÄ‚îÄ üìÅ logs/                  # Archivos de log
‚îú‚îÄ‚îÄ üìÑ requirements.txt       # Dependencias Python
‚îú‚îÄ‚îÄ üìÑ .env.example          # Template configuraci√≥n
‚îú‚îÄ‚îÄ üìÑ run.py                # Punto de entrada
‚îú‚îÄ‚îÄ üìÑ utils.py              # Scripts de utilidad
‚îú‚îÄ‚îÄ üìÑ diagnose.py           # Diagn√≥stico del sistema
‚îî‚îÄ‚îÄ üìÑ client_example.py     # Cliente de prueba
```

### üîÑ Flujo de Procesamiento

```mermaid
sequenceDiagram
    participant C as Cliente
    participant F as FastAPI
    participant CS as ChatService
    participant LLM as LLMService
    participant E as EmbeddingService
    participant V as VectorDB
    participant K as KafkaService

    C->>F: POST /chat/
    F->>CS: process_message()
    CS->>E: generate_embedding()
    E->>V: similarity_search()
    V-->>CS: relevant_context
    CS->>LLM: generate_response()
    LLM-->>CS: ai_response
    CS->>K: send_message()
    CS-->>F: final_response
    F-->>C: JSON response
```

### üß© Servicios Principales

#### 1. **ChatService** - Orquestador Central

- Coordina todos los servicios
- Gestiona flujo de conversaci√≥n
- Mantiene contexto entre mensajes

#### 2. **LLMService** - Integraci√≥n con Ollama

- Comunicaci√≥n con modelos de lenguaje
- Gesti√≥n de prompts y respuestas
- Soporte para streaming

#### 3. **EmbeddingService** - Vectorizaci√≥n

- Genera embeddings de documentos
- Procesa consultas para b√∫squeda
- Optimiza chunks de texto

#### 4. **VectorDBService** - ChromaDB

- Almacena embeddings
- B√∫squeda de similitud
- Gesti√≥n de colecciones

#### 5. **KafkaService** - Distribuci√≥n (Opcional)

- Publica mensajes a topics
- Maneja reconexiones
- Batch y streaming

## üõ†Ô∏è Scripts de Utilidad

### üìã Scripts Disponibles

```powershell
# Configuraci√≥n autom√°tica
python utils.py setup           # Instala dependencias y configura

# Verificaci√≥n del sistema
python utils.py check           # Verifica todos los servicios
python diagnose.py              # Diagn√≥stico detallado

# Ejecuci√≥n del servidor
python utils.py start           # Inicia servidor
python utils.py start --reload  # Con recarga autom√°tica
python run.py                   # M√©todo directo

# Pruebas y ejemplos
python client_example.py        # Cliente de prueba
python verify_kafka.py          # Verificar Kafka
python test_integration.py      # Pruebas de integraci√≥n
```

### üîß Utilidades de Desarrollo

```powershell
# Ver logs en tiempo real
Get-Content -Wait -Tail 10 logs/app.log

# Verificar estado de servicios
python -c "from app.dependencies import get_chat_service; print(get_chat_service().health_check())"

# Probar conectividad Ollama
curl http://localhost:11434/api/tags

# Limpiar base de datos vectorial
Remove-Item -Recurse -Force chroma_db
```

## üö® Resoluci√≥n de Problemas

### üîç Diagn√≥stico R√°pido

```powershell
# Ejecutar diagn√≥stico autom√°tico
python diagnose.py

# Verificar configuraci√≥n
python utils.py check

# Comprobar servicios individualmente
python -c "from app.dependencies import get_chat_service; service = get_chat_service(); print(service.health_check())"
```

### ‚ùå Errores Comunes

| Error                         | Causa                | Soluci√≥n                        |
| ----------------------------- | -------------------- | ------------------------------- |
| `BaseSettings has been moved` | Pydantic v2          | `pip install pydantic-settings` |
| `Ollama not running`          | Ollama no iniciado   | `ollama serve`                  |
| `Model not found`             | Modelo no descargado | `ollama pull phi3:3.8b`         |
| `Port already in use`         | Puerto ocupado       | Cambiar `PORT` en `.env`        |
| `ChromaDB permission denied`  | Permisos directorio  | Verificar permisos `chroma_db/` |

### üîß Comandos de Diagn√≥stico

```powershell
# Verificar Ollama
ollama list
curl http://localhost:11434/api/tags

# Verificar puerto
netstat -ano | findstr :8000

# Verificar logs
Get-Content logs/app.log -Tail 20

# Test de dependencias
python -c "import fastapi, langchain, chromadb, ollama; print('‚úÖ Todas las dependencias OK')"
```

### üìä Monitoreo en Tiempo Real

```powershell
# Logs del servidor
Get-Content -Wait logs/app.log

# Estado de salud
curl http://localhost:8000/health/

# M√©tricas de documentos
curl http://localhost:8000/documents/stats

# Test b√°sico
curl -X POST http://localhost:8000/chat/ -H "Content-Type: application/json" -d '{"message":"test"}'
```

## üéØ Casos de Uso

### üíº Implementaciones T√≠picas

#### 1. **Chatbot Corporativo**

```python
# Configurar con documentos de empresa
POST /documents/
{
  "content": "Manual de procedimientos...",
  "metadata": {"department": "HR"}
}

# Chat con contexto corporativo
POST /chat/
{
  "message": "¬øCu√°l es la pol√≠tica de vacaciones?",
  "use_context": true
}
```

#### 2. **Asistente de Documentaci√≥n**

```python
# Cargar documentaci√≥n t√©cnica
POST /documents/
{
  "content": "Documentaci√≥n de API...",
  "metadata": {"type": "api_docs"}
}

# Consultas espec√≠ficas
POST /chat/
{
  "message": "¬øC√≥mo implementar autenticaci√≥n?",
  "use_context": true
}
```

#### 3. **Sistema de Conocimiento**

```python
# M√∫ltiples fuentes de informaci√≥n
# Streaming para respuestas largas
POST /chat/stream
{
  "message": "Explica arquitectura de microservicios",
  "use_context": true
}
```

## üìà Extensiones y Mejoras

### üîÆ Funcionalidades Avanzadas

- **üîê Autenticaci√≥n**: Agregar JWT/OAuth
- **üåê Multi-idioma**: Soporte para m√∫ltiples idiomas
- **üìä Analytics**: M√©tricas de uso y performance
- **üîÑ Cache**: Redis para respuestas frecuentes
- **üõ°Ô∏è Rate Limiting**: Control de velocidad de requests
- **üì± WebSocket**: Chat en tiempo real
- **üóÉÔ∏è Base de Datos**: PostgreSQL para persistencia
- **‚òÅÔ∏è Cloud**: Despliegue en AWS/Azure/GCP

### üß© Integraci√≥n con Otros Servicios

```python
# Ejemplo: A√±adir nuevo servicio
# app/services/translation_service.py
class TranslationService:
    async def translate(self, text: str, target_lang: str) -> str:
        # Implementar traducci√≥n
        pass

# app/api/translation.py
@router.post("/translate")
async def translate_text(request: TranslationRequest):
    # Endpoint de traducci√≥n
    pass
```

## üìö Referencias y Recursos

### üîó Documentaci√≥n Oficial

- **FastAPI**: https://fastapi.tiangolo.com/
- **LangChain**: https://python.langchain.com/
- **Ollama**: https://github.com/ollama/ollama
- **ChromaDB**: https://docs.trychroma.com/
- **Pydantic**: https://docs.pydantic.dev/

### üìñ Gu√≠as Relacionadas

- `../README_KAFKA.md` - Documentaci√≥n completa del sistema
- `QUICKSTART.md` - Gu√≠a de inicio r√°pido
- `.env.example` - Variables de entorno disponibles

---

## üìû Informaci√≥n del Proyecto

**üè∑Ô∏è Versi√≥n**: 1.0.0  
**üêç Python**: 3.11+  
**üìÑ Licencia**: MIT  
**üìÖ √öltima actualizaci√≥n**: Julio 2025

### üöÄ Comandos de Resumen

```powershell
# Setup completo en una l√≠nea
python -m venv .venv && .venv\Scripts\activate && pip install -r requirements.txt && copy .env.example .env && python run.py

# Verificaci√≥n r√°pida
python utils.py check && curl http://localhost:8000/health/

# Documentaci√≥n local
# http://localhost:8000/docs
```
